name: Cleanup old workflow runs

on:
  schedule:
    # æ¯å‘¨æ—¥ 22:00 åŒ—äº¬æ—¶é—´ â†’ UTC 14:00
    - cron: "0 14 * * 0"
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup jq
        run: sudo apt-get install -y jq

      - name: Cleanup old workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP_DAYS: 1
          OWNER: ${{ github.repository_owner }}
          FULL_REPO: ${{ github.repository }}
        run: |
          echo "ğŸ•’ ä¿ç•™æœ€è¿‘ $KEEP_DAYS å¤©å†…çš„ workflow runs"

          # ä» owner/repo ä¸­æå– repo å
          REPO="${FULL_REPO#*/}"

          echo "ğŸ“¦ ä»“åº“: $OWNER / $REPO"

          THRESHOLD=$(date -d "-$KEEP_DAYS days" --utc +%Y-%m-%dT%H:%M:%SZ)
          echo "ğŸ—“ï¸ åˆ é™¤åˆ›å»ºæ—¶é—´ < $THRESHOLD çš„ runs"

          page=1
          per_page=100

          while true; do
              echo "ğŸ“„ è·å–ç¬¬ $page é¡µ runs..."

              runs_json=$(curl -s \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  "https://api.github.com/repos/$OWNER/$REPO/actions/runs?per_page=$per_page&page=$page")

              run_count=$(echo "$runs_json" | jq '.workflow_runs | length')

              if [[ "$run_count" -eq 0 ]]; then
                  echo "âœ… å·²å¤„ç†å®Œæ‰€æœ‰ runs"
                  break
              fi

              echo "ğŸ‘‰ æœ¬é¡µå…±æœ‰ $run_count ä¸ª runs"

              for row in $(echo "$runs_json" | jq -r '.workflow_runs[] | @base64'); do
                  decode() { echo "$row" | base64 --decode | jq -r "$1"; }

                  id=$(decode '.id')
                  created_at=$(decode '.created_at')

                  if [[ "$created_at" < "$THRESHOLD" ]]; then
                      echo "ğŸ—‘ï¸ åˆ é™¤ run: $id (åˆ›å»ºäº $created_at)"

                      # åˆ é™¤ artifacts
                      artifacts=$(curl -s \
                          -H "Authorization: token $GITHUB_TOKEN" \
                          "https://api.github.com/repos/$OWNER/$REPO/actions/runs/$id/artifacts" \
                          | jq -r '.artifacts[].id')

                      for artifact_id in $artifacts; do
                          echo "   â¤ åˆ é™¤ artifact: $artifact_id"
                          curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                              "https://api.github.com/repos/$OWNER/$REPO/actions/artifacts/$artifact_id" > /dev/null
                      done

                      curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                          "https://api.github.com/repos/$OWNER/$REPO/actions/runs/$id" > /dev/null
                  fi
              done

              ((page++))
          done

          echo "ğŸ‰ æ¸…ç†å®Œæˆï¼"
